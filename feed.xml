<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.0.0">Jekyll</generator><link href="/feed.xml" rel="self" type="application/atom+xml" /><link href="/" rel="alternate" type="text/html" /><updated>2021-02-06T18:58:33+01:00</updated><id>/feed.xml</id><title type="html">Your awesome title</title><subtitle>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</subtitle><entry><title type="html">Reversing a simple cryptosystem</title><link href="/reverse/games/2021/02/06/simple-cryptosystem.html" rel="alternate" type="text/html" title="Reversing a simple cryptosystem" /><published>2021-02-06T17:18:21+01:00</published><updated>2021-02-06T17:18:21+01:00</updated><id>/reverse/games/2021/02/06/simple-cryptosystem</id><content type="html" xml:base="/reverse/games/2021/02/06/simple-cryptosystem.html">&lt;p&gt; From a technical standpoint, video games are really interesting. Not only they impose the players rules that virtually can’t be broken, but they also heavily rely on parsing, AI, networking, external execution units (scripts) and others interesting stuff. The biggest games are massive though. Yet, I managed to find a small French “amateur-ish” MMORPG that I thought would be quick to study. It was actually a quite interesting project.&lt;/p&gt;

&lt;p&gt;Online games are usually interesting to reverse for their network protocols. Digging around in Wireshark, I was unable to correlate in-game behaviours and network packets though. Sure there was some traffic. But there was no plaintext (that could be player messages or whatever) and repeating actions were never duplicate packets; suggesting encryption or at least modification of the original data.&lt;/p&gt;

&lt;h1 id=&quot;discovery&quot;&gt;Discovery&lt;/h1&gt;

&lt;p&gt; The game is divided in two binaries: the launcher in charge of updating the local files; and the game client. On startup, the launcher welcomes the player with a Message of the Day containing the number of online players: data only known by the game server. Having both the plaintext (shown by the launcher) and the ciphertext (seen on Wireshark) is a good starting point.&lt;/p&gt;

&lt;p&gt;IDA could find a bunch of stripped symbols (the binary is neither packed or obfuscated, phew) but it has also fingerprinted a Delphi standard library. A few breakpoints on symbols containing the string “read” highlighted one in particular: &lt;code class=&quot;highlighter-rouge&quot;&gt;Idtcpconnection::ReadFromStack&lt;/code&gt;, part of the Delphi library.
This method returns exactly the number of bytes of each packet seen on Wireshark.
Another call to &lt;code class=&quot;highlighter-rouge&quot;&gt;TIdManagedBuffer::Memory(void)&lt;/code&gt; fills &lt;em&gt;eax&lt;/em&gt; with a pointer to the raw data .&lt;/p&gt;

&lt;h1 id=&quot;decryption&quot;&gt;Decryption&lt;/h1&gt;

&lt;p&gt; Using a watch rule on the pointer, I ended up in a method that was overwriting the buffer with the exact MOTD shown on the launcher. Here is the most important of it with my comments:&lt;/p&gt;

&lt;div class=&quot;language-nasm highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;sub_4852E0&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;near&lt;/span&gt;         &lt;span class=&quot;c&quot;&gt;; sub_4852E0(key, packet)&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;; FASTCALL convention:&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;; - param_1 (eax)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;; - param_2 (edx)&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;; [...]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_8&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; var_8 contains the encrypted packet&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;al&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[eax]&lt;/span&gt;            &lt;span class=&quot;c&quot;&gt;; al = packet[0]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;xor&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;al&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;21&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;h&lt;/span&gt;              &lt;span class=&quot;c&quot;&gt;; al = al ^ 0x21&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;esi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;and&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;esi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FFh&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;esi&lt;/span&gt;             &lt;span class=&quot;c&quot;&gt;; ebx = esi &amp;amp; 0xFF&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;; =&amp;gt; ebx stores first index&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_8&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; var_8 contains the encrypted packet&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;call&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;unknown_libname_82&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;; unknown_libname_82(packet) - returns packet length&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;edx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_8&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;al&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;edx&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;      &lt;span class=&quot;c&quot;&gt;; al = packet[packet.length() - 1]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;xor&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;al&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;h&lt;/span&gt;              &lt;span class=&quot;c&quot;&gt;; al = al ^ 0x42&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;and&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FFh&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_10&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;; var_10 = eax &amp;amp; 0xFF&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;; =&amp;gt; var_10 stores second index&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_8&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; var_8 contains the encrypted packet&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;cmp&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;byte&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ptr&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[eax],&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FFh&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;; if packet[0] == 0xFF&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;setz&lt;/span&gt;    &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_11&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;         &lt;span class=&quot;c&quot;&gt;; then var_11 = 1 else var_11 = 0&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_8&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; var_8 contains the encrypted packet&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;call&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;unknown_libname_82&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;; unknown_libname_82(packet) - returns packet length&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;dec&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;                  &lt;span class=&quot;c&quot;&gt;; packet length - 1&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;sub&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;               &lt;span class=&quot;c&quot;&gt;; packet length - 2&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;jl&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;short&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loc_4853B7&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; jump after main loop if packet is empty&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;inc&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_18&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;edi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;; this is the main loop&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;loc_48535D&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;cmp&lt;/span&gt;     &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_11&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;      &lt;span class=&quot;c&quot;&gt;; if var_11 == 0&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;jz&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;short&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loc_485369&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; then jump to decryption process&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_11&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;      &lt;span class=&quot;c&quot;&gt;; otherwise set var_11 to 0&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;jmp&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;short&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loc_485394&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; and jump just after the decryption process&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;loc_485369&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_8&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; var_8 contains the encrypted packet&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;cmp&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;byte&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ptr&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;edi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FFh&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;; if packet[edi - 1] == 0xFF&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;setz&lt;/span&gt;    &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_11&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;         &lt;span class=&quot;c&quot;&gt;; then var_11 = 1 else var_11 = 0&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;lea&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_8&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;call&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;j_unknown_libname_83_0&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;; somekind of a string conversion function, probably used to escape weird characters, let's ignore it&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;; the decryption process happens here&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;edx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_8&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; var_8 contains the encrypted packet&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;dl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;edx&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;edi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;      &lt;span class=&quot;c&quot;&gt;; dl = packet[edi -1]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;ecx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_4&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; var_4 contains the decryption key&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;xor&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;dl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ecx&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;esi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;360&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;h&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;; dl = dl ^ key[esi] (static decryption key)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;xor&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;dl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bl&lt;/span&gt;               &lt;span class=&quot;c&quot;&gt;; dl = dl ^ bl (first index)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;edi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dl&lt;/span&gt;      &lt;span class=&quot;c&quot;&gt;; packet[edi - 1] = dl&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;loc_485394&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;add&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;esi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_10&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;; esi += var_10 (second index)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;sub&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_10&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;; ebx -= var_10 (second index)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;add&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;               &lt;span class=&quot;c&quot;&gt;; ebx += 3 (first index)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;cmp&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;esi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;h&lt;/span&gt;            &lt;span class=&quot;c&quot;&gt;; if esi &amp;gt;= 0x100&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;jl&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;short&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loc_4853AA&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;esi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;               &lt;span class=&quot;c&quot;&gt;; then ebx = 1&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;loc_4853AA&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;cmp&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;               &lt;span class=&quot;c&quot;&gt;; if ebx &amp;lt; 1&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;jge&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;short&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loc_4853B1&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;esi&lt;/span&gt;             &lt;span class=&quot;c&quot;&gt;; then ebx = esi&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;loc_4853B1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;inc&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;edi&lt;/span&gt;                  &lt;span class=&quot;c&quot;&gt;; edi++&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;dec&lt;/span&gt;     &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_18&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;         &lt;span class=&quot;c&quot;&gt;; var_18-- ; if var_18 != 0&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;jnz&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;short&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loc_48535D&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; then jump back beginning of loop&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;; [...]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The decryption method can be broken down in two distinct operations:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;a xor between the packet byte and the key byte at position &lt;em&gt;esi&lt;/em&gt;&lt;/li&gt;
  &lt;li&gt;a xor with the value of &lt;em&gt;ebx&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Both &lt;em&gt;esi&lt;/em&gt; and &lt;em&gt;ebx&lt;/em&gt; are calculated from the first packet byte xor-ed to a static value of 0x21. A &lt;em&gt;step&lt;/em&gt; is calculated from the last packet byte xor-ed to a static value of 0x42. The latter is added to &lt;em&gt;esi&lt;/em&gt; and substracted to &lt;em&gt;ebx&lt;/em&gt; for each loop cycle, making the decryption key to “slide” along the packet bytes.&lt;/p&gt;

&lt;p&gt;It can be noted that each packet ends by &lt;code class=&quot;highlighter-rouge&quot;&gt;[0xFF,0xFF]&lt;/code&gt; so a packet of size 2 is considered empty.&lt;/p&gt;

&lt;h1 id=&quot;encryption&quot;&gt;Encryption&lt;/h1&gt;

&lt;p&gt; At first I thought it would be easier to “deduce” the encryption method from the decryption assembly. It ain’t no fun though and I wanted to know how the two indexes were generated. So instead, by backtracing the decryption function, I went back to the caller and found a symbol overwriting the string “version:6”. It looks like this:&lt;/p&gt;

&lt;div class=&quot;language-nasm highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;sub_485034&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;near&lt;/span&gt;         &lt;span class=&quot;c&quot;&gt;; sub_485034(key, &quot;version:6&quot;)&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;; FASTCALL convention:&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;; - param_1 (eax)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;; - param_2 (edx)&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;; [...]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FCh&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;call&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;unknown_libname_47&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;; unknown_libname_47(0xFC) - returns first index&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;inc&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;                  &lt;span class=&quot;c&quot;&gt;; (first index)++&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;esi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;h&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;call&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;unknown_libname_47&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;; unknown_libname_47(0x14) - returns second index&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_C&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;edi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;xor&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;edi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;21&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;h&lt;/span&gt;             &lt;span class=&quot;c&quot;&gt;; edi = (first index) ^ 0x21&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;lea&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_18&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;edx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;edi&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;call&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;unknown_libname_77&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;; unknown_libname_77(edi) - returns a string containing first index&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;push&lt;/span&gt;    &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_18&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;push&lt;/span&gt;    &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_8&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;lea&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_1C&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;dl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;byte&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ptr&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_C&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;xor&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;dl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;h&lt;/span&gt;              &lt;span class=&quot;c&quot;&gt;; dl = (second index) ^ 0x42&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;call&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;unknown_libname_77&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;; unknown_libname_77(edx) - returns a string containing second index&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;push&lt;/span&gt;    &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_1C&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;lea&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_8&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;edx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;call&lt;/span&gt;    &lt;span class=&quot;err&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;@@&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LStrCatN&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;qqrv&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;; strcat() - returns (first index) + &quot;version:6&quot; + (second index)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;cmp&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;edi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FFh&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;setz&lt;/span&gt;    &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_D&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_8&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; var_8 = strcat string result&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;call&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;unknown_libname_82&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;; strlen(var_8) - returns 11&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;dec&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;sub&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;               &lt;span class=&quot;c&quot;&gt;; if length &amp;lt; 2&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;jl&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;short&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loc_48512A&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; then jump after loop&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;inc&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_14&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;edi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;; this is the main loop&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;loc_4850D4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;cmp&lt;/span&gt;     &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_D&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;       &lt;span class=&quot;c&quot;&gt;; if var_D != 0&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;jnz&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;short&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loc_4850FB&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; then jump after decryption process&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;lea&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_8&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; var_8 = string to encrypt&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;call&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;j_unknown_libname_83_0&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;; ignored by me&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;edx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_8&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;dl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;edx&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;edi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;      &lt;span class=&quot;c&quot;&gt;; dl = string[edi - 1]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;ecx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_4&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;xor&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;dl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ecx&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;360&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;h&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;; dl = dl ^ key[ebx]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;ecx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;esi&lt;/span&gt;             &lt;span class=&quot;c&quot;&gt;; cl = (esi &amp;amp; 0xFF)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;xor&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;dl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cl&lt;/span&gt;               &lt;span class=&quot;c&quot;&gt;; dl = dl ^ cl&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;edi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dl&lt;/span&gt;      &lt;span class=&quot;c&quot;&gt;; string[edi - 1] = dl&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;loc_4850FB&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_8&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; eax = string&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;cmp&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;byte&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ptr&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;edi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FFh&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;; if var_8[edi - 1] == 0xFF&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;setz&lt;/span&gt;    &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_D&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;          &lt;span class=&quot;c&quot;&gt;; then var_D = 1 else var_D = 0&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;add&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_C&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; ebx += var_C&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;sub&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;esi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_C&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; esi -= var_C&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;add&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;esi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;               &lt;span class=&quot;c&quot;&gt;; esi += 3&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;cmp&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;h&lt;/span&gt;            &lt;span class=&quot;c&quot;&gt;; if ebx &amp;gt;= 256&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;jl&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;short&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loc_48511D&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;               &lt;span class=&quot;c&quot;&gt;; then ebx = 1&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;loc_48511D&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;cmp&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;esi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;               &lt;span class=&quot;c&quot;&gt;; if esi &amp;lt; 1&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;jge&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;short&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loc_485124&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;esi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;             &lt;span class=&quot;c&quot;&gt;; then esi = ebx&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;loc_485124&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;inc&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;edi&lt;/span&gt;                  &lt;span class=&quot;c&quot;&gt;; edi++&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;dec&lt;/span&gt;     &lt;span class=&quot;err&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ebp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;var_14&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;]&lt;/span&gt;         &lt;span class=&quot;c&quot;&gt;; var_14-- ; if var_14 != 0&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;jnz&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;short&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loc_4850D4&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;; then jump back beginning of loop&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;; [...]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;No mystery here, encryption is pretty similar to decryption in the other way around. The two indexes used as a &lt;em&gt;step&lt;/em&gt; are calculated by &lt;code class=&quot;highlighter-rouge&quot;&gt;unknown_libname_47&lt;/code&gt; which looks like this:&lt;/p&gt;

&lt;div class=&quot;language-nasm highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;unknown_libname_47&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;near&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;; unknown_libname_47(value)&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;; FASTCALL convention:&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;; - param_1 (eax)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;push&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;xor&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;            &lt;span class=&quot;c&quot;&gt;; ebx = 0&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;imul&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;edx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ds&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dword_489008&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[ebx],&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8088405&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;h&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;; edx = dword_489008[0] * 0x8088405&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;inc&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;edx&lt;/span&gt;                 &lt;span class=&quot;c&quot;&gt;; edx++&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;ds&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dword_489008&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[ebx],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;edx&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;; dword_489008[0] = edx&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mul&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;edx&lt;/span&gt;                 &lt;span class=&quot;c&quot;&gt;; edx = edx * value&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mov&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;edx&lt;/span&gt;            &lt;span class=&quot;c&quot;&gt;; returns edx&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;pop&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;ebx&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;retn&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Interesting one. Each call to &lt;code class=&quot;highlighter-rouge&quot;&gt;unknown_libname_47&lt;/code&gt; is a multiplication of a value stored at &lt;em&gt;dword_489008&lt;/em&gt; and the constant &lt;em&gt;0x8088405&lt;/em&gt;. The result is then increased by one and stored back to &lt;em&gt;dword_489008&lt;/em&gt;. This is probably done because the initial value of &lt;em&gt;dword_489008&lt;/em&gt; is zero and the multiplication would be zero every single time otherwise.
Indexes are the multiplication of &lt;em&gt;dword_489008&lt;/em&gt; and the first argument value. That means index calculations are deterministic and rely only on &lt;code class=&quot;highlighter-rouge&quot;&gt;unknown_libname_47&lt;/code&gt;’s last calls.&lt;/p&gt;

&lt;h1 id=&quot;extracting-the-key&quot;&gt;Extracting the key&lt;/h1&gt;

&lt;p&gt; Using a debugger is a pretty straightforward way to export the symmetric-key. A breakpoint on the right function (encryption or decryption) and a copy/paste of the buffer at &lt;em&gt;eax&lt;/em&gt; is enough. I found it boring and wanted to “automate” the process with Frida. A simple script for a simple problem:&lt;/p&gt;

&lt;div class=&quot;language-javascript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;decryptor&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;resolveAddress&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;0x4852E0&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Intercepting function at address &lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;decryptor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;nx&quot;&gt;Interceptor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;attach&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;decryptor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;onEnter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;offset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ptr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;0x360&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;arg&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ptr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;eax&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;hexdump&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;arg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;256&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;header&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;ansi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}));&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;(Full script available &lt;a href=&quot;https://github.com/t3ssel/002-simple-cryptosystem/blob/main/extract_key.py&quot;&gt;here&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Note: FASTCALL prevents me from using &lt;code class=&quot;highlighter-rouge&quot;&gt;args&lt;/code&gt; directly. I believe Frida works with stdcall by default and the calling convention cannot be changed from the JS API.&lt;/p&gt;

&lt;h1 id=&quot;in-the-end&quot;&gt;In the end&lt;/h1&gt;

&lt;p&gt; For the encryption and decryption functions, it would have probably been easier to use emulators like &lt;a href=&quot;https://github.com/unicorn-engine/unicorn&quot;&gt;Unicorn&lt;/a&gt; or &lt;a href=&quot;https://github.com/cea-sec/miasm&quot;&gt;miasm&lt;/a&gt;. I took the time to understand how the functions were implemented and decided to &lt;a href=&quot;https://github.com/t3ssel/002-simple-cryptosystem/blob/main/src/crypto.py&quot;&gt;reimplement them in Python&lt;/a&gt;. First because of course it was a lot of fun. But I also think it will help me to have a standalone code I can manipulate. From this, I can start analysing the network protocol writing a MITM tool, or even try to replace a game server or game client. Next step: understanding the network protocol.&lt;/p&gt;</content><author><name></name></author><summary type="html"> From a technical standpoint, video games are really interesting. Not only they impose the players rules that virtually can’t be broken, but they also heavily rely on parsing, AI, networking, external execution units (scripts) and others interesting stuff. The biggest games are massive though. Yet, I managed to find a small French “amateur-ish” MMORPG that I thought would be quick to study. It was actually a quite interesting project.</summary></entry><entry><title type="html">UT2004 Dedicated server notes</title><link href="/infra/games/2021/01/23/ut2004-dedicated-server.html" rel="alternate" type="text/html" title="UT2004 Dedicated server notes" /><published>2021-01-23T17:44:00+01:00</published><updated>2021-01-23T17:44:00+01:00</updated><id>/infra/games/2021/01/23/ut2004-dedicated-server</id><content type="html" xml:base="/infra/games/2021/01/23/ut2004-dedicated-server.html">&lt;p&gt; The Unreal series have always been very important to me. I literally have them all, including the old solo games and the console ones. Unreal Tournament 2004, however, was a very interesting one. A full working editor (UnrealEd) was included out of the box, aside of the game, expanding the game lifetime by a lot. The main trend was to create maps, which were often “signed” by their author, like &lt;a href=&quot;https://unrealarchive.org/maps/unreal-tournament-2004/deathmatch/U/dm-under_le_a12b017d.html&quot;&gt;Under_LE&lt;/a&gt;, but executing code was also possible using the UnrealScript language. In the end, the game was so editable you could create a new game out of it.&lt;/p&gt;

&lt;p&gt;After almost 20 years, I finally decided to launch my own public server game, or at least to try, and it was a real hassle. Almost all the official ressources are offline or not working (watching you the serial key generator). In the end, I have finally a running dedicated server, here are my notes.&lt;/p&gt;

&lt;h1 id=&quot;prerequisites&quot;&gt;Prerequisites&lt;/h1&gt;

&lt;p&gt;Assuming you have a fresh Debian installation, you’ll also need:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;the &lt;a href=&quot;https://www.ausgamers.com/files/download/20778/unreal-tournament-2004-dedicated-server-v3339&quot;&gt;Unreal Tournament 2004 Dedicated Server v3339&lt;/a&gt;;&lt;/li&gt;
  &lt;li&gt;the &lt;a href=&quot;https://www.ausgamers.com/files/download/20096/unreal-tournament-2004-patch-v33692-for-linux&quot;&gt;Unreal Tournament 2004 Patch v3369.2 for Linux&lt;/a&gt;;&lt;/li&gt;
  &lt;li&gt;a &lt;a href=&quot;https://www.epicgames.com/unrealtournament/forums/cdkey.php?2004&quot;&gt;game server serial key&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;installation&quot;&gt;Installation&lt;/h1&gt;

&lt;p&gt;Please create a dedicated user (you’ll be running a 20 years old binary after all)&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;adduser unreal&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Game server is 32bits&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;dpkg &lt;span class=&quot;nt&quot;&gt;--add-architecture&lt;/span&gt; i386
apt-get update
apt-get &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;libstdc++5 libstdc++5:i386&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;On dedicated user, unzip files and patch game server&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;unzip DedicatedServer3339-BonusPack.zip &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; ut2004
&lt;span class=&quot;nb&quot;&gt;tar &lt;/span&gt;jxvf ut2004-lnxpatch3369-2.tar.bz2
&lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; ut2004-lnxpatch3369-2/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; ut2004/&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Install serial key&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[serial key]&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; ut2004/System/cdkey&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h1 id=&quot;configuration&quot;&gt;Configuration&lt;/h1&gt;

&lt;p&gt;Setting up your server can be a long and painful task. Here are the main settings you’ll need to edit, for more read the &lt;a href=&quot;https://unrealadmin.org/server_ini_reference/ut2004&quot;&gt;ini reference guide&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;url&quot;&gt;[URL]&lt;/h2&gt;

&lt;p&gt;Listening port:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;Port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;7777&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;engineengine&quot;&gt;[Engine.Engine]&lt;/h2&gt;

&lt;p&gt;Select a gamemode from the &lt;a href=&quot;https://wiki.unrealadmin.org/Gametype_List_%28UT2004%29&quot;&gt;gamemode list&lt;/a&gt;:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;DefaultGame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;XGame.XDeathmatch 	&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;DefaultServerGame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;XGame.XDeathmatch&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Note: overwritten from the command line options.&lt;/p&gt;

&lt;h2 id=&quot;enginegameengine&quot;&gt;[Engine.GameEngine]&lt;/h2&gt;

&lt;p&gt;Please disable the VoIP subsystem (could lead to security issues):&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;VoIPAllowVAD&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;False&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Package list, force players to download them if missing locally:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;ServerPackages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;satoreMonsterPackv120&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;enginegameinfo&quot;&gt;[Engine.GameInfo]&lt;/h2&gt;

&lt;p&gt;If you enable the voting system, you need to link it:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;VotingHandlerType&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;xVoting.xVotingHandler&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;xvotingxvotinghandler&quot;&gt;[xVoting.xVotingHandler]&lt;/h2&gt;

&lt;p&gt;Map voting system configuration:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;nn&quot;&gt;[xVoting.xVotingHandler]&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;VoteTimeLimit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;70&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;ScoreBoardDelay&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;bAutoOpen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;True&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;MidGameVotePercent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;50&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;bScoreMode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;False&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;bAccumulationMode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;False&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;bEliminationMode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;False&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;MinMapCount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;MapVoteHistoryType&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;xVoting.MapVoteHistory_INI&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;RepeatLimit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;DefaultGameConfig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;bDefaultToCurrentGameType&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;True&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;bMapVote&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;False&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;bKickVote&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;False&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;bMatchSetup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;False&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;KickPercent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;51&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;bAnonymousKicking&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;True&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;MapListLoaderType&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;xVoting.DefaultMapListLoader&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;ServerNumber&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;CurrentGameConfig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;GameConfig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;(GameClass=&quot;XGame.xDeathMatch&quot;,Prefix=,Acronym=,GameName=&quot;new&quot;,Mutators=,Options=) &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Note: don’t forget to edit your GameClass according to your gamemode, your Mutators list and your prefix/acronym values to the maps you want to play on (example: &lt;code class=&quot;highlighter-rouge&quot;&gt;Prefix=&quot;DM&quot;,Acronym=&quot;DM&quot;&lt;/code&gt; for DM* maps).&lt;/p&gt;

&lt;h2 id=&quot;ipdrvtcpnetdriver&quot;&gt;[IpDrv.TcpNetDriver]&lt;/h2&gt;

&lt;p&gt;Allow players to download files directly from your game server:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;AllowDownloads&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;True&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Maximum bit rate given to each player:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;MaxInternetClientRate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;20000&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;ipdrvmasterserveruplink&quot;&gt;[IpDrv.MasterServerUplink]&lt;/h2&gt;

&lt;p&gt;Make you server publicly visible:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;DoUplink&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;True&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Disable Gamespy (this service is now offline):&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;UplinkToGamespy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;False&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Disable statistics sent to master server:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;SendStats&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;False&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;If behind a NAT firewall, prevents ping to be shown as &lt;code class=&quot;highlighter-rouge&quot;&gt;N/A&lt;/code&gt;:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;ServerBehindNAT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;False&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;enginegameinfo-1&quot;&gt;[Engine.GameInfo]&lt;/h2&gt;

&lt;p&gt;Disable statistic generator:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;bEnableStatLogging&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;False&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Max number of spectators:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;MaxSpectators&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;2&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Max number of players:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;MaxPlayers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;16&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Will weapon stay after being picked up:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;bWeaponStay&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;True&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Allow players to drop weapons:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;bAllowWeaponThrowing&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;True&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Can admin players pause the game:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;bAdminCanPause&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;True&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;enginegamereplicationinfo&quot;&gt;[Engine.GameReplicationInfo]&lt;/h2&gt;

&lt;p&gt;Server name show in server list:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;ServerName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Amazing and crazy server&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Admin name shown in server info:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;AdminName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;SuperAmazingAdmin&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Admin email address shown in server info:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;AdminEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;admin@superserver.com&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;A message of the day shown on player screen:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;MessageOfTheDay&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Welcome!|This is a new line&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;uwebwebserver&quot;&gt;[UWeb.WebServer]&lt;/h2&gt;

&lt;p&gt;Enable/disable admin web console:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span class=&quot;py&quot;&gt;bEnabled&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;True&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;ListenPort&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;80&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Note: crashes when moving pages around too quickly (&lt;code class=&quot;highlighter-rouge&quot;&gt;Close: Error while attempting to close socket.&lt;/code&gt;).&lt;/p&gt;

&lt;h1 id=&quot;mutator-installation&quot;&gt;Mutator installation&lt;/h1&gt;

&lt;p&gt;To install a mutator, copy the &lt;code class=&quot;highlighter-rouge&quot;&gt;System/*&lt;/code&gt; files to your &lt;code class=&quot;highlighter-rouge&quot;&gt;System/&lt;/code&gt; folder, the &lt;code class=&quot;highlighter-rouge&quot;&gt;StaticMeshes/*&lt;/code&gt; files to your &lt;code class=&quot;highlighter-rouge&quot;&gt;StaticMeshes/&lt;/code&gt; folder and so on.
Each mutator has a unique package name located in its &lt;code class=&quot;highlighter-rouge&quot;&gt;.ucl&lt;/code&gt; file:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Mutator=(ClassName=MyMutatorName.SubClassName)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then add its package name (here &lt;code class=&quot;highlighter-rouge&quot;&gt;MyMutatorName&lt;/code&gt;) to your &lt;code class=&quot;highlighter-rouge&quot;&gt;ServerPackages&lt;/code&gt; list and its full class name to your &lt;code class=&quot;highlighter-rouge&quot;&gt;Mutators&lt;/code&gt; list (both in your voting subsystem and command line options).&lt;/p&gt;

&lt;p&gt;Their configuration usually comes from a &lt;code class=&quot;highlighter-rouge&quot;&gt;PackageName.ini&lt;/code&gt; file in your &lt;code class=&quot;highlighter-rouge&quot;&gt;System&lt;/code&gt; folder (here &lt;code class=&quot;highlighter-rouge&quot;&gt;System/MyMutatorName.ini&lt;/code&gt;) that you can force the generation of by starting a game locally with the mutator enabled.&lt;/p&gt;

&lt;h1 id=&quot;systemd-service&quot;&gt;Systemd service&lt;/h1&gt;

&lt;p&gt;An example of a systemd service, can be written in &lt;code class=&quot;highlighter-rouge&quot;&gt;/lib/systemd/system/ut2004.service&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[Unit]
Description=Unreal 2004 Dedicated game server
After=network.target

[Service]
Type=simple
User=unreal
WorkingDirectory=/home/unreal/ut2004/System
ExecStart=/home/unreal/ut2004/System/ucc-bin-linux-amd64 server CTF-BridgeOfFate?game=XGame.xCTFGame?AdminName=admin?AdminPassword=XXXXXXXX ini=UT2004.ini log=server.log -nohomedir
Restart=always
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Note: edit your gamemode, admin credentials and mutator list if needed.&lt;/p&gt;

&lt;h1 id=&quot;summary&quot;&gt;Summary&lt;/h1&gt;

&lt;p&gt; Most of the time everything works pretty well. You can also completely remove everything related to graphical settings in your ini file in you want to. I also had issues with the admin web console (crashing non stop) and the &lt;a href=&quot;https://wiki.unrealadmin.org/Ports_%28UT%29&quot;&gt;ports list&lt;/a&gt; which seems to be outdated. I ended up opening them all which I discourage to do. Can’t wait for Fornite to die so we can finally have a new finished and polished Unreal game.&lt;/p&gt;

&lt;h1 id=&quot;links&quot;&gt;Links&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;Unreal Admin setup guide: &lt;a href=&quot;https://wiki.unrealadmin.org/Server_Setup_%28UT2004%29&quot;&gt;https://wiki.unrealadmin.org/Server_Setup_%28UT2004%29&lt;/a&gt;;&lt;/li&gt;
  &lt;li&gt;Default gamemode list: &lt;a href=&quot;https://wiki.unrealadmin.org/Gametype_List_%28UT2004%29&quot;&gt;https://wiki.unrealadmin.org/Gametype_List_%28UT2004%29&lt;/a&gt;;&lt;/li&gt;
  &lt;li&gt;Default mutator list: &lt;a href=&quot;https://wiki.unrealadmin.org/Mutator_List_%28UT2004%29&quot;&gt;https://wiki.unrealadmin.org/Mutator_List_%28UT2004%29&lt;/a&gt;;&lt;/li&gt;
  &lt;li&gt;Command line parameters: &lt;a href=&quot;https://wiki.unrealadmin.org/Commandline_Parameters_%28UT2004%29&quot;&gt;https://wiki.unrealadmin.org/Commandline_Parameters_%28UT2004%29&lt;/a&gt;;&lt;/li&gt;
  &lt;li&gt;Another useful guide: &lt;a href=&quot;https://www.lucaswilliams.net/index.php/2017/12/04/setting-up-unreal-tournament-2004-game-server-on-ubuntu-16-04/&quot;&gt;https://www.lucaswilliams.net/index.php/2017/12/04/setting-up-unreal-tournament-2004-game-server-on-ubuntu-16-04/&lt;/a&gt;;&lt;/li&gt;
  &lt;li&gt;Unreal archive: &lt;a href=&quot;https://unrealarchive.org/index.html&quot;&gt;https://unrealarchive.org/index.html&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;</content><author><name></name></author><summary type="html"> The Unreal series have always been very important to me. I literally have them all, including the old solo games and the console ones. Unreal Tournament 2004, however, was a very interesting one. A full working editor (UnrealEd) was included out of the box, aside of the game, expanding the game lifetime by a lot. The main trend was to create maps, which were often “signed” by their author, like Under_LE, but executing code was also possible using the UnrealScript language. In the end, the game was so editable you could create a new game out of it.</summary></entry></feed>